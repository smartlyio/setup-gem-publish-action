test:
  runs-on: <%= ubuntu_version %>
  steps:
  - uses: actions/checkout@v3
  - name: Set Node.js 20.x
    uses: actions/setup-node@v3
    with:
      node-version: 20.x
  - name: "Build action for test"
    run: |
      npm install
      npm run all
      git clean -fXd
  - name: Test executing the action
    uses: ./
    env:
      GIT_DEPLOY_KEY: not-a-real-key
    with:
      email: ${{ env.EMAIL_INPUT }}
      username: ${{ env.USERNAME_INPUT }}
  - name: Validate result
    run: |
      set -u

      DIRECTORIES=("$RUNNER_TEMP"/_github_home_*)

      [ "${#DIRECTORIES[@]}" -eq 1 ]

      ACTIONS_DIR="${DIRECTORIES[0]}"

      cat "$RUNNER_TEMP/"*"/id_rsa"
      echo
      git config user.name
      git config user.email
      git remote get-url origin
      git config core.sshCommand
      grep '^github\.com' "$ACTION_DIR/known_hosts"

      [[ "$(cat "$ACTION_DIR/id_rsa")" == "not-a-real-key" ]]
      [[ "$(git config user.name)" == "${{ env.USERNAME_INPUT }}" ]]
      [[ "$(git config user.email)" == "${{ env.EMAIL_INPUT }}" ]]
      [[ "$(git remote get-url origin)" == "git@github.com:$GITHUB_REPOSITORY.git" ]]

      # Just check that it is altered from default
      [[ "$(git config core.sshCommand)" == *UserKnownHostsFile* ]]
